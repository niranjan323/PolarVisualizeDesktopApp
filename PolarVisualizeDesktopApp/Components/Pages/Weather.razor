@* @page "/weather"
@using PolarVisualizeDesktopApp.Services
@using DevExpress.Maui.Charts
@using DevExpress.Maui.Editors
@using DevExpress.Maui.Controls
@inject PolarService PolarService

<PageTitle>Polar Response - DevExpress</PageTitle>

<div class="container-fluid p-3">
    <div class="row">
        <!-- Left Panel - Controls -->
        <div class="col-md-3 col-lg-2">
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0">
                        Vessel Operation Conditions
                        @if (vesselInfo != null)
                        {
                            <br />
                            <small class="text-muted">IMO: @vesselInfo.IMO</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Draft Category</label>
                        <select class="form-select form-select-sm" @bind="parameters.Draft">
                            <option value="scantling">Scantling</option>
                            <option value="design">Design</option>
                            <option value="intermediate">Intermediate</option>
                        </select>
                        @if (representativeDrafts != null)
                        {
                            <small class="text-muted">
                                S:@representativeDrafts.Ts.ToString("F0")m /
                                D:@representativeDrafts.Td.ToString("F0")m /
                                I:@representativeDrafts.Ti.ToString("F0")m
                            </small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Draft Aft Peak (m)</label>
                        <input type="number" class="form-control form-control-sm" @bind="parameters.DraftAftPeak"
                               step="0.1" min="0" max="30" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Draft Fore Peak (m)</label>
                        <input type="number" class="form-control form-control-sm" @bind="parameters.DraftForePeak"
                               step="0.1" min="0" max="30" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Metacentric Height, GM (m)</label>
                        <input type="number" class="form-control form-control-sm" @bind="parameters.GM"
                               step="0.5" min="@parameterBounds.GM_lower" max="@parameterBounds.GM_upper" />
                        @if (parameterBounds.GM_lower > 0)
                        {
                            <small class="text-muted">
                                Range: [@parameterBounds.GM_lower.ToString("F1"), @parameterBounds.GM_upper.ToString("F1")]
                            </small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Heading (degree)</label>
                        <input type="number" class="form-control form-control-sm" @bind="vesselHeading"
                               step="1" min="0" max="360" />
                        <small class="form-text text-muted">Clockwise from North to Bow</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Speed (kn)</label>
                        <input type="number" class="form-control form-control-sm" @bind="vesselSpeed"
                               step="0.5" min="0" max="30" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Maximum Allowed Roll Angle (degree)</label>
                        <input type="number" class="form-control form-control-sm" @bind="maxRollAngle"
                               step="1" min="0" max="30" />
                    </div>
                </div>

                <div class="card-header">
                    <h5 class="mb-0">Sea State</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Significant Wave Height, Hs (m)</label>
                        <input type="number" class="form-control form-control-sm" @bind="parameters.Hs"
                               step="0.5" min="@parameterBounds.Hs_lower" max="@parameterBounds.Hs_upper" />
                        @if (parameterBounds.Hs_lower > 0)
                        {
                            <small class="text-muted">
                                Range: [@parameterBounds.Hs_lower.ToString("F1"), @parameterBounds.Hs_upper.ToString("F1")]
                            </small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mean Wave Period, Tz (s)</label>
                        <input type="number" class="form-control form-control-sm" @bind="parameters.Tz"
                               step="0.5" min="@parameterBounds.Tz_lower" max="@parameterBounds.Tz_upper" />
                        @if (parameterBounds.Tz_lower > 0)
                        {
                            <small class="text-muted">
                                Range: [@parameterBounds.Tz_lower.ToString("F1"), @parameterBounds.Tz_upper.ToString("F1")]
                            </small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mean Wave Direction (degree)</label>
                        <input type="number" class="form-control form-control-sm" @bind="waveDirection"
                               step="1" min="0" max="360" />
                        <small class="form-text text-muted">Clockwise from North</small>
                    </div>
                </div>

                <div class="card-header">
                    <h5 class="mb-0">Display Options</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Plot Mode</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="plotMode"
                                   value="continuous" @onchange="@(() => { displayMode = "continuous"; OnDisplayModeChanged(); })"
                                   checked="@(displayMode == "continuous")" />
                            <label class="form-check-label">Continuous</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="plotMode"
                                   value="trafficlight" @onchange="@(() => { displayMode = "trafficlight"; OnDisplayModeChanged(); })"
                                   checked="@(displayMode == "trafficlight")" />
                            <label class="form-check-label">Traffic Light</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Direction</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dirMode"
                                   value="northup" @onchange="@(() => { directionMode = "northup"; OnDisplayModeChanged(); })"
                                   checked="@(directionMode == "northup")" />
                            <label class="form-check-label">North Up</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dirMode"
                                   value="headsup" @onchange="@(() => { directionMode = "headsup"; OnDisplayModeChanged(); })"
                                   checked="@(directionMode == "headsup")" />
                            <label class="form-check-label">Heads Up</label>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <button class="btn btn-primary w-100 mb-2 btn-sm" @onclick="LoadAndRenderData" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Load & Render
                    </button>
                    <button class="btn btn-success w-100 mb-2 btn-sm" @onclick="SaveCase" disabled="@(!hasData)">
                        Save Case
                    </button>
                    <button class="btn btn-info w-100 btn-sm" @onclick="ExportChart" disabled="@(!hasData)">
                        Export Image
                    </button>
                </div>
            </div>
        </div>

        <!-- Center Panel - Chart -->
        <div class="col-md-6 col-lg-7">
            <div class="card bg-dark text-white" style="height: 750px;">
                <div class="card-body p-2 position-relative">
                    @if (controlFileError != null)
                    {
                        <div class="alert alert-warning" role="alert">
                            <strong>Control File Info:</strong> @controlFileError
                        </div>
                    }

                    @if (errorMessage != null)
                    {
                        <div class="alert alert-danger" role="alert">
                            <strong>Error:</strong> @errorMessage
                        </div>
                    }

                    @if (!hasData && errorMessage == null)
                    {
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 16.016a7.5 7.5 0 0 0 1.962-14.74A1 1 0 0 0 9 0H7a1 1 0 0 0-.962 1.276A7.5 7.5 0 0 0 8 16.016zm6.5-7.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z" />
                                    <path d="m6.94 7.44 4.95-2.83-2.83 4.95-4.949 2.83 2.828-4.95z" />
                                </svg>
                                <h4 class="mt-3">No Data Loaded</h4>
                                <p>Configure parameters and click "Load & Render"</p>
                            </div>
                        </div>
                    }
                    else if (hasData)
                    {
                        <div id="devexpressChartContainer" style="width: 100%; height: 700px;">
                            <canvas id="polarCanvas" width="700" height="700" style="background: transparent;"></canvas>
                        </div>

                        <!-- Legend -->
                        <div style="position: absolute; top: 60px; left: 30px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 5px; z-index: 1000;">
                            @if (displayMode == "trafficlight")
                            {
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 24px; height: 24px; background: #2ecc71; border-radius: 3px;"></div>
                                        <span style="color: white; font-size: 12px;">Safe (0-@((maxRollAngle - 5).ToString("F0"))°)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 24px; height: 24px; background: #f39c12; border-radius: 3px;"></div>
                                        <span style="color: white; font-size: 12px;">Caution (@((maxRollAngle - 5).ToString("F0"))-@(maxRollAngle.ToString("F0"))°)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 24px; height: 24px; background: #e74c3c; border-radius: 3px;"></div>
                                        <span style="color: white; font-size: 12px;">Danger (&gt;@(maxRollAngle.ToString("F0"))°)</span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 24px; height: 140px; background: linear-gradient(to top, #0d47a1, #00bcd4, #ffeb3b, #ff9800, #d32f2f); border-radius: 3px;"></div>
                                    <div style="display: flex; flex-direction: column; justify-content: space-between; height: 140px; color: white; font-size: 12px;">
                                        <span>@maxRollAngle.ToString("F0")°</span>
                                        <span>0°</span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Compass Labels -->
                        @if (directionMode == "northup")
                        {
                            <div style="position: absolute; top: 40px; left: 50%; transform: translateX(-50%); color: #FFD700; font-weight: bold; font-size: 22px; z-index: 1000;">N</div>
                            <div style="position: absolute; top: 50%; right: 60px; transform: translateY(-50%); color: #C0C0C0; font-weight: bold; font-size: 20px; z-index: 1000;">E</div>
                            <div style="position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); color: #C0C0C0; font-weight: bold; font-size: 20px; z-index: 1000;">S</div>
                            <div style="position: absolute; top: 50%; left: 60px; transform: translateY(-50%); color: #C0C0C0; font-weight: bold; font-size: 20px; z-index: 1000;">W</div>
                        }
                    }
                </div>
            </div>

            <!-- Case Selector -->
            @if (hasData && savedCases.Count > 0)
            {
                <div class="card bg-dark text-white mt-2">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <button class="btn btn-sm btn-secondary" @onclick="PreviousCase">&lt;&lt;</button>
                            @for (int i = 0; i < savedCases.Count; i++)
                            {
                                var index = i;
                                var isActive = index == currentCaseIndex;
                                var statusColor = savedCases[i].IsInDangerZone ? "danger" : "success";
                                var btnClass = isActive ? "btn-primary" : $"btn-outline-{statusColor}";
                                <button class="btn btn-sm mx-1 @btnClass" @onclick="() => LoadCase(index)">
                                    Case @(i + 1)
                                </button>
                            }
                            <button class="btn btn-sm btn-secondary" @onclick="NextCase">&gt;&gt;</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Right Panel - Info -->
        <div class="col-md-3 col-lg-3">
            @if (loadResult != null && loadResult.Success)
            {
                <div class="card bg-dark text-white">
                    <div class="card-header">
                        <h6 class="mb-0">Polar Diagram Closest to Request</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Draft:</strong> @parameters.Draft</p>
                        <p class="mb-1"><strong>GM:</strong> @loadResult.FittedGM.ToString("F1") m</p>
                        <p class="mb-1"><strong>Hs:</strong> @loadResult.FittedHs.ToString("F1") m</p>
                        <p class="mb-0"><strong>Tz:</strong> @loadResult.FittedTz.ToString("F1") s</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private VesselInfo? vesselInfo = null;
    private RepresentativeDraft? representativeDrafts = null;
    private ParameterBound parameterBounds = new();
    private string? controlFileError = null;

    private PolarLoadParameters parameters = new()
    {
        Draft = "scantling",
        GM = 1.5,
        Hs = 5.5,
        Tz = 7.5,
        DraftAftPeak = 0.5,
        DraftForePeak = 0.5
    };

    private double vesselHeading = 5;
    private double vesselSpeed = 10;
    private double waveDirection = 0;
    private double maxRollAngle = 15;
    private string displayMode = "trafficlight";
    private string directionMode = "northup";

    private bool isLoading = false;
    private bool hasData = false;
    private string? errorMessage = null;
    private PolarLoadResult? loadResult = null;
    private double maxSpeed = 20;

    private List<SavedCase> savedCases = new();
    private int currentCaseIndex = 0;

    private List<ContourSeries> contourSeries = new();

    public class SavedCase
    {
        public string Id { get; set; } = "";
        public PolarLoadParameters Parameters { get; set; } = new();
        public bool IsInDangerZone { get; set; }
    }

    public class ContourSeries
    {
        public List<PolarChartData> Points { get; set; } = new();
        public string Color { get; set; } = "";
        public double Opacity { get; set; } = 0.8;
        public double MinRoll { get; set; }
        public double MaxRoll { get; set; }
    }

    public class PolarChartData
    {
        public double Angle { get; set; }
        public double Speed { get; set; }
        public double Roll { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        LoadControlFileFromDataFolder();
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (hasData && contourSeries.Count > 0)
        {
            await RenderPolarChart();
        }
    }

    private void LoadControlFileFromDataFolder()
    {
        try
        {
            string dataPath = PolarService.GetDataRootPath();
            string[] possibleNames = { "proll.ctl", "control.txt", "vessel.ctl" };
            string? controlFilePath = null;

            foreach (var name in possibleNames)
            {
                string testPath = System.IO.Path.Combine(dataPath, name);
                if (System.IO.File.Exists(testPath))
                {
                    controlFilePath = testPath;
                    break;
                }
            }

            if (controlFilePath != null)
            {
                if (PolarService.LoadControlFile(controlFilePath))
                {
                    vesselInfo = PolarService.GetVesselInfo();
                    representativeDrafts = PolarService.GetRepresentativeDrafts();
                    parameterBounds = PolarService.GetParameterBounds();
                    controlFileError = null;
                }
                else
                {
                    controlFileError = $"Found control file but failed to parse";
                }
            }
            else
            {
                controlFileError = "Control file not found. Using defaults.";
                parameterBounds = new ParameterBound
                {
                    GM_lower = 0.5,
                    GM_upper = 5.0,
                    Hs_lower = 3.0,
                    Hs_upper = 12.0,
                    Tz_lower = 5.0,
                    Tz_upper = 18.0
                };
            }
        }
        catch (Exception ex)
        {
            controlFileError = $"Error: {ex.Message}";
        }
    }

    private void OnDisplayModeChanged()
    {
        if (hasData)
        {
            PrepareChartData();
            StateHasChanged();
        }
    }

    private async Task LoadAndRenderData()
    {
        isLoading = true;
        errorMessage = null;
        hasData = false;
        StateHasChanged();

        await Task.Delay(100);

        try
        {
            loadResult = PolarService.LoadPolarData(parameters);

            if (!loadResult.Success)
            {
                errorMessage = loadResult.ErrorMessage;
                return;
            }

            hasData = true;
            PrepareChartData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            hasData = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void PrepareChartData()
    {
        if (loadResult?.Data == null) return;

        var data = loadResult.Data;
        contourSeries.Clear();

        maxSpeed = Math.Ceiling(data.Speeds.Max() * 1.1);

        if (displayMode == "trafficlight")
        {
            CreateTrafficLightContours(data);
        }
        else
        {
            CreateContinuousContours(data);
        }
    }

    private void CreateTrafficLightContours(ResponseMatrix data)
    {
        var greenZone = new ContourSeries { Color = "#2ecc71", Opacity = 0.75, MinRoll = 0, MaxRoll = maxRollAngle - 5 };
        var yellowZone = new ContourSeries { Color = "#f39c12", Opacity = 0.75, MinRoll = maxRollAngle - 5, MaxRoll = maxRollAngle };
        var redZone = new ContourSeries { Color = "#e74c3c", Opacity = 0.75, MinRoll = maxRollAngle, MaxRoll = 999 };

        int angleStep = 5;
        
        for (int angle = 0; angle < 360; angle += angleStep)
        {
            double greenBoundary = InterpolateBoundaryAtAngle(data, angle, greenZone.MaxRoll);
            double yellowBoundary = InterpolateBoundaryAtAngle(data, angle, yellowZone.MaxRoll);

            if (greenBoundary > 0)
                greenZone.Points.Add(new PolarChartData { Angle = angle, Speed = greenBoundary });
            
            if (yellowBoundary > greenBoundary)
                yellowZone.Points.Add(new PolarChartData { Angle = angle, Speed = yellowBoundary });
            
            redZone.Points.Add(new PolarChartData { Angle = angle, Speed = maxSpeed });
        }

        if (greenZone.Points.Count > 0)
            greenZone.Points.Add(new PolarChartData { Angle = 0, Speed = greenZone.Points[0].Speed });
        
        if (yellowZone.Points.Count > 0)
            yellowZone.Points.Add(new PolarChartData { Angle = 0, Speed = yellowZone.Points[0].Speed });
        
        if (redZone.Points.Count > 0)
            redZone.Points.Add(new PolarChartData { Angle = 0, Speed = redZone.Points[0].Speed });

        contourSeries.Add(redZone);
        contourSeries.Add(yellowZone);
        contourSeries.Add(greenZone);
    }

    private void CreateContinuousContours(ResponseMatrix data)
    {
        int numBands = 10;
        string[] colors = new[]
        {
            "#0d47a1", "#1976d2", "#42a5f5", "#64b5f6", "#90caf9",
            "#ffeb3b", "#ff9800", "#ff5722", "#e64a19", "#d32f2f"
        };

        int angleStep = 5;

        for (int band = 0; band < numBands; band++)
        {
            double minRoll = (maxRollAngle * band) / numBands;
            double maxRoll = (maxRollAngle * (band + 1)) / numBands;

            var series = new ContourSeries
            {
                Color = colors[band],
                Opacity = 0.65,
                MinRoll = minRoll,
                MaxRoll = maxRoll
            };

            for (int angle = 0; angle < 360; angle += angleStep)
            {
                double boundary = InterpolateBoundaryAtAngle(data, angle, maxRoll);
                if (boundary > 0)
                    series.Points.Add(new PolarChartData { Angle = angle, Speed = boundary });
            }

            if (series.Points.Count > 0)
                series.Points.Add(new PolarChartData { Angle = 0, Speed = series.Points[0].Speed });

            contourSeries.Add(series);
        }

        contourSeries.Reverse();
    }

    private double InterpolateBoundaryAtAngle(ResponseMatrix data, double targetAngle, double rollThreshold)
    {
        int nearestIndex1 = -1;
        int nearestIndex2 = -1;
        double minDiff1 = 360;
        double minDiff2 = 360;

        for (int j = 0; j < data.HeadingCount; j++)
        {
            double diff = Math.Abs(data.Headings[j] - targetAngle);
            if (diff > 180) diff = 360 - diff;

            if (diff < minDiff1)
            {
                minDiff2 = minDiff1;
                nearestIndex2 = nearestIndex1;
                minDiff1 = diff;
                nearestIndex1 = j;
            }
            else if (diff < minDiff2)
            {
                minDiff2 = diff;
                nearestIndex2 = j;
            }
        }

        if (nearestIndex1 < 0) return 0;

        double boundary1 = FindSpeedBoundary(data, nearestIndex1, rollThreshold);

        if (nearestIndex2 >= 0 && minDiff1 < 30)
        {
            double boundary2 = FindSpeedBoundary(data, nearestIndex2, rollThreshold);
            double weight = minDiff1 / (minDiff1 + minDiff2);
            return boundary1 * (1 - weight) + boundary2 * weight;
        }

        return boundary1;
    }

    private double FindSpeedBoundary(ResponseMatrix data, int headingIndex, double rollThreshold)
    {
        for (int i = data.SpeedCount - 1; i >= 0; i--)
        {
            if (data.MaxRoll[i, headingIndex] <= rollThreshold)
            {
                return data.Speeds[i];
            }
        }
        return 0;
    }

    private async Task RenderPolarChart()
    {
        var chartDataJson = System.Text.Json.JsonSerializer.Serialize(new
        {
            contours = contourSeries.Select(s => new
            {
                points = s.Points.Select(p => new { angle = p.Angle, speed = p.Speed }).ToArray(),
                color = s.Color,
                opacity = s.Opacity
            }).ToArray(),
            vesselHeading = vesselHeading,
            vesselSpeed = vesselSpeed,
            waveDirection = waveDirection,
            maxSpeed = maxSpeed,
            directionMode = directionMode
        });

        await JSRuntime.InvokeVoidAsync("window.devExpressPolarChart.render", chartDataJson);
    }

    private async Task SaveCase()
    {
        var newCase = new SavedCase
        {
            Id = $"Case {savedCases.Count + 1}",
            Parameters = new PolarLoadParameters
            {
                Draft = parameters.Draft,
                GM = parameters.GM,
                Hs = parameters.Hs,
                Tz = parameters.Tz,
                DraftAftPeak = parameters.DraftAftPeak,
                DraftForePeak = parameters.DraftForePeak
            },
            IsInDangerZone = contourSeries.Any(s => s.MinRoll > maxRollAngle)
        };

        savedCases.Add(newCase);
        currentCaseIndex = savedCases.Count - 1;
        StateHasChanged();
    }

    private void LoadCase(int index)
    {
        if (index >= 0 && index < savedCases.Count)
        {
            currentCaseIndex = index;
            parameters = savedCases[index].Parameters;
            _ = LoadAndRenderData();
        }
    }

    private void PreviousCase()
    {
        if (currentCaseIndex > 0) LoadCase(currentCaseIndex - 1);
    }

    private void NextCase()
    {
        if (currentCaseIndex < savedCases.Count - 1) LoadCase(currentCaseIndex + 1);
    }

    private async Task ExportChart()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("window.devExpressPolarChart.exportImage");
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
            await Task.Delay(2000);
            errorMessage = null;
        }
    }
} *@
