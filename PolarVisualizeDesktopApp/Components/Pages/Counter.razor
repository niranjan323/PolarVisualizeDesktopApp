@page "/counter"
@using PolarVisualizeDesktopApp.Services
@using Syncfusion.Blazor.Charts
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.DropDowns
@inject PolarService PolarService
@inject IJSRuntime JSRuntime

<PageTitle>Polar Response Visualization</PageTitle>

<div class="container-fluid p-3">
    <!-- Main Application UI -->
    <div class="row">
        <!-- Left Panel - Controls -->
        <div class="col-md-3 col-lg-2">
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0">
                        Vessel Operation Conditions
                        @if (vesselInfo != null)
                        {
                            <br />
                            <small class="text-muted">IMO: @vesselInfo.IMO</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Draft Selection -->
                    <div class="mb-3">
                        <label class="form-label">Draft Category</label>
                        <SfDropDownList TValue="string" TItem="string"
                                        @bind-Value="parameters.Draft"
                                        DataSource="@draftOptions"
                                        CssClass="e-outline">
                        </SfDropDownList>
                        @if (representativeDrafts != null)
                        {
                            <small class="text-muted">
                                S:@representativeDrafts.Ts.ToString("F0")m /
                                D:@representativeDrafts.Td.ToString("F0")m /
                                I:@representativeDrafts.Ti.ToString("F0")m
                            </small>
                        }
                    </div>

                    <!-- Draft Aft Peak -->
                    <div class="mb-3">
                        <label class="form-label">Draft Aft Peak (m)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="parameters.DraftAftPeak"
                                          Min="0" Max="30" Step="0.1"
                                          Format="F1"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                    </div>

                    <!-- Draft Fore Peak -->
                    <div class="mb-3">
                        <label class="form-label">Draft Fore Peak (m)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="parameters.DraftForePeak"
                                          Min="0" Max="30" Step="0.1"
                                          Format="F1"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                    </div>

                    <!-- GM -->
                    <div class="mb-3">
                        <label class="form-label">Metacentric Height, GM (m)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="parameters.GM"
                                          Min="@parameterBounds.GM_lower" Max="@parameterBounds.GM_upper"
                                          Step="0.5"
                                          Format="F1"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                        @if (parameterBounds.GM_lower > 0)
                        {
                            <small class="text-muted">
                                Range: [@parameterBounds.GM_lower.ToString("F1"), @parameterBounds.GM_upper.ToString("F1")]
                            </small>
                        }
                    </div>

                    <!-- Heading -->
                    <div class="mb-3">
                        <label class="form-label">Heading (degree)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="vesselHeading"
                                          Min="0" Max="360" Step="1"
                                          Format="F0"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                        <small class="form-text text-muted">Clockwise from North to Bow</small>
                    </div>

                    <!-- Speed -->
                    <div class="mb-3">
                        <label class="form-label">Speed (kn)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="vesselSpeed"
                                          Min="0" Max="30" Step="0.5"
                                          Format="F1"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                    </div>

                    <!-- Maximum Roll -->
                    <div class="mb-3">
                        <label class="form-label">Maximum Allowed Roll Angle (degree)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="maxRollAngle"
                                          Min="0" Max="30" Step="1"
                                          Format="F0"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                    </div>
                </div>

                <div class="card-header">
                    <h5 class="mb-0">Sea State</h5>
                </div>
                <div class="card-body">
                    <!-- Significant Wave Height -->
                    <div class="mb-3">
                        <label class="form-label">Significant Wave Height, Hs (m)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="parameters.Hs"
                                          Min="@parameterBounds.Hs_lower" Max="@parameterBounds.Hs_upper"
                                          Step="0.5"
                                          Format="F1"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                        @if (parameterBounds.Hs_lower > 0)
                        {
                            <small class="text-muted">
                                Range: [@parameterBounds.Hs_lower.ToString("F1"), @parameterBounds.Hs_upper.ToString("F1")]
                            </small>
                        }
                    </div>

                    <!-- Mean Wave Period -->
                    <div class="mb-3">
                        <label class="form-label">Mean Wave Period, Tz (s)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="parameters.Tz"
                                          Min="@parameterBounds.Tz_lower" Max="@parameterBounds.Tz_upper"
                                          Step="0.5"
                                          Format="F1"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                        @if (parameterBounds.Tz_lower > 0)
                        {
                            <small class="text-muted">
                                Range: [@parameterBounds.Tz_lower.ToString("F1"), @parameterBounds.Tz_upper.ToString("F1")]
                            </small>
                        }
                    </div>

                    <!-- Mean Wave Direction -->
                    <div class="mb-3">
                        <label class="form-label">Mean Wave Direction (degree)</label>
                        <SfNumericTextBox TValue="double"
                                          @bind-Value="waveDirection"
                                          Min="0" Max="360" Step="1"
                                          Format="F0"
                                          CssClass="e-outline"
                                          ShowSpinButton="true">
                        </SfNumericTextBox>
                        <small class="form-text text-muted">Clockwise from North</small>
                    </div>
                </div>

                <div class="card-header">
                    <h5 class="mb-0">Display Options</h5>
                </div>
                <div class="card-body">
                    <!-- Display Mode -->
                    <div class="mb-3">
                        <label class="form-label">Plot Mode</label>
                        <div>
                            <SfRadioButton TChecked="string" TValue="string"
                                           Label="Continuous"
                                           Name="plotMode"
                                           Value="continuous"
                                           @bind-Checked="displayMode"
                                           ValueChange="@OnDisplayModeChanged">
                            </SfRadioButton>
                        </div>
                        <div>
                            <SfRadioButton TChecked="string" TValue="string"
                                           Label="Traffic Light"
                                           Name="plotMode"
                                           Value="trafficlight"
                                           @bind-Checked="displayMode"
                                           ValueChange="@OnDisplayModeChanged">
                            </SfRadioButton>
                        </div>
                    </div>

                    <!-- Direction Display -->
                    <div class="mb-3">
                        <label class="form-label">Direction</label>
                        <div>
                            <SfRadioButton TChecked="string" TValue="string"
                                           Label="North Up"
                                           Name="dirMode"
                                           Value="northup"
                                           @bind-Checked="directionMode"
                                           ValueChange="@OnDisplayModeChanged">
                            </SfRadioButton>
                        </div>
                        <div>
                            <SfRadioButton TChecked="string" TValue="string"
                                           Label="Heads Up"
                                           Name="dirMode"
                                           Value="headsup"
                                           @bind-Checked="directionMode"
                                           ValueChange="@OnDisplayModeChanged">
                            </SfRadioButton>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <SfButton IsPrimary="true"
                              Content="@(isLoading ? "Loading..." : "Load & Render")"
                              CssClass="e-block mb-2"
                              Disabled="@isLoading"
                              @onclick="LoadAndRenderData">
                    </SfButton>
                    <SfButton Content="Save Case"
                              CssClass="e-success e-block mb-2"
                              Disabled="@(!hasData)"
                              @onclick="SaveCase">
                    </SfButton>
                    <SfButton Content="Export Image"
                              CssClass="e-info e-block"
                              Disabled="@(!hasData)"
                              @onclick="ExportChart">
                    </SfButton>
                </div>
            </div>
        </div>

        <!-- Center Panel - Chart -->
        <div class="col-md-6 col-lg-7">
            <div class="card bg-dark text-white" style="height: 750px;">
                <div class="card-body p-2">
                    @if (controlFileError != null)
                    {
                        <div class="alert alert-warning" role="alert">
                            <strong>Control File Info:</strong> @controlFileError
                        </div>
                    }

                    @if (errorMessage != null)
                    {
                        <div class="alert alert-danger" role="alert">
                            <strong>Error:</strong> @errorMessage
                        </div>
                    }

                    @if (!hasData && errorMessage == null)
                    {
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-compass" viewBox="0 0 16 16">
                                    <path d="M8 16.016a7.5 7.5 0 0 0 1.962-14.74A1 1 0 0 0 9 0H7a1 1 0 0 0-.962 1.276A7.5 7.5 0 0 0 8 16.016zm6.5-7.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z" />
                                    <path d="m6.94 7.44 4.95-2.83-2.83 4.95-4.949 2.83 2.828-4.95z" />
                                </svg>
                                <h4 class="mt-3">No Data Loaded</h4>
                                <p>Configure parameters and click "Load & Render"</p>
                            </div>
                        </div>
                    }
                    else if (hasData)
                    {
                        <SfChart @ref="chartRef" 
                                 Title="Roll Angle (degrees)"
                                 Background="transparent"
                                 Height="700px"
                                 Theme="Syncfusion.Blazor.Theme.Bootstrap5Dark">

                            <ChartArea>
                                <ChartAreaBorder Width="0"></ChartAreaBorder>
                            </ChartArea>

                            <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Double"
                                               Minimum="0"
                                               Maximum="360"
                                               Interval="30"
                                               LabelFormat="{value}°"
                                               StartAngle="@startAngle"
                                               Coefficient="@coefficient">
                                <ChartAxisMajorGridLines Width="1" Color="#555"></ChartAxisMajorGridLines>
                                <ChartAxisLabelStyle Color="#ffffff" Size="12px"></ChartAxisLabelStyle>
                            </ChartPrimaryXAxis>

                            <ChartPrimaryYAxis Minimum="0"
                                               Maximum="@maxSpeed"
                                               Interval="5"
                                               LabelFormat="{value} kn">
                                <ChartAxisMajorGridLines Width="1" Color="#555"></ChartAxisMajorGridLines>
                                <ChartAxisLabelStyle Color="#ffffff" Size="12px"></ChartAxisLabelStyle>
                            </ChartPrimaryYAxis>

                            <ChartSeriesCollection>
                                <!-- Main data points with color coding -->
                                <ChartSeries DataSource="@chartDataPoints"
                                             XName="Angle"
                                             YName="Speed"
                                             Type="ChartSeriesType.Polar"
                                             DrawType="ChartDrawType.Scatter"
                                             PointColorMapping="Color">
                                    <ChartMarker Height="8" Width="8">
                                    </ChartMarker>
                                </ChartSeries>

                                <!-- Vessel position marker -->
                                @if (vesselSpeed > 0)
                                {
                                    <ChartSeries DataSource="@vesselMarker"
                                                 XName="Angle"
                                                 YName="Speed"
                                                 Type="ChartSeriesType.Polar"
                                                 DrawType="ChartDrawType.Scatter"
                                                 Fill="#FFFFFF">
                                        <ChartMarker Height="20" Width="20" Shape="ChartShape.Triangle">
                                            <ChartMarkerBorder Color="#000000" Width="2"></ChartMarkerBorder>
                                        </ChartMarker>
                                    </ChartSeries>
                                }

                                <!-- Wave direction marker -->
                                <ChartSeries DataSource="@waveMarker"
                                             XName="Angle"
                                             YName="Speed"
                                             Type="ChartSeriesType.Polar"
                                             DrawType="ChartDrawType.Scatter"
                                             Fill="#FF1493">
                                    <ChartMarker Height="18" Width="18" Shape="ChartShape.Triangle">
                                        <ChartMarkerBorder Color="#FFFFFF" Width="2"></ChartMarkerBorder>
                                    </ChartMarker>
                                </ChartSeries>
                            </ChartSeriesCollection>

                            <ChartTooltipSettings Enable="true"
                                                  Format="Heading: ${point.x}°<br/>Speed: ${point.y} kn<br/>Roll: ${point.tooltip}°">
                            </ChartTooltipSettings>

                            <ChartLegendSettings Visible="false"></ChartLegendSettings>

                            <!-- Add compass labels as annotations -->
                        <ChartAnnotations>
                            @if (directionMode == "northup")
                            {
                                <ChartAnnotation X="50" Y="5" Region="Syncfusion.Blazor.Charts.Regions.Chart">
                                    <ContentTemplate>
                                        <div style="color: #FFD700; font-weight: bold; font-size: 20px;">N</div>
                                    </ContentTemplate>
                                </ChartAnnotation>
                                <ChartAnnotation X="350" Y="200" Region="Syncfusion.Blazor.Charts.Regions.Chart">
                                    <ContentTemplate>
                                        <div style="color: #C0C0C0; font-weight: bold; font-size: 18px;">E</div>
                                    </ContentTemplate>
                                </ChartAnnotation>
                                <ChartAnnotation X="50" Y="400" Region="Syncfusion.Blazor.Charts.Regions.Chart">
                                    <ContentTemplate>
                                        <div style="color: #C0C0C0; font-weight: bold; font-size: 18px;">S</div>
                                    </ContentTemplate>
                                </ChartAnnotation>
                                <ChartAnnotation X="5" Y="200" Region="Syncfusion.Blazor.Charts.Regions.Chart">
                                    <ContentTemplate>
                                        <div style="color: #C0C0C0; font-weight: bold; font-size: 18px;">W</div>
                                    </ContentTemplate>
                                </ChartAnnotation>
                            }
                        </ChartAnnotations>
                        </SfChart>

                        <!-- Legend -->
                        <div style="position: absolute; top: 50px; left: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;">
                            @if (displayMode == "trafficlight")
                            {
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 20px; height: 20px; background: #2ecc71;"></div>
                                        <span style="color: white; font-size: 11px;">Safe (0-@((maxRollAngle - 5).ToString("F0"))°)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 20px; height: 20px; background: #f39c12;"></div>
                                        <span style="color: white; font-size: 11px;">Caution (@((maxRollAngle - 5).ToString("F0"))-@(maxRollAngle.ToString("F0"))°)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 20px; height: 20px; background: #e74c3c;"></div>
                                        <span style="color: white; font-size: 11px;">Danger (&gt;@(maxRollAngle.ToString("F0"))°)</span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 120px; background: linear-gradient(to top, #0d47a1, #00bcd4, #ffeb3b, #ff9800, #d32f2f);"></div>
                                    <div style="display: flex; flex-direction: column; justify-content: space-between; height: 120px; color: white; font-size: 11px;">
                                        <span>@maxRollAngle.ToString("F0")°</span>
                                        <span>0°</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Case Selector at Bottom -->
            @if (hasData && savedCases.Count > 0)
            {
                <div class="card bg-dark text-white mt-2">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <SfButton Content="<<" CssClass="e-small" @onclick="PreviousCase"></SfButton>

                            @for (int i = 0; i < savedCases.Count; i++)
                            {
                                var index = i;
                                var isActive = index == currentCaseIndex;
                                var statusColor = savedCases[i].IsInDangerZone ? "e-danger" : "e-success";
                                var cssClass = isActive ? "e-primary" : statusColor;

                                <SfButton Content="@($"Case {i + 1}")"
                                          CssClass="@($"e-small {cssClass}")"
                                          @onclick="() => LoadCase(index)">
                                </SfButton>
                            }

                            <SfButton Content=">>" CssClass="e-small" @onclick="NextCase"></SfButton>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Right Panel - Info -->
        <div class="col-md-3 col-lg-3">
            @if (loadResult != null && loadResult.Success)
            {
                <div class="card bg-dark text-white">
                    <div class="card-header">
                        <h6 class="mb-0">Polar Diagram Closest to Request</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Draft:</strong> @parameters.Draft</p>
                        <p class="mb-1"><strong>GM:</strong> @loadResult.FittedGM.ToString("F1") m</p>
                        <p class="mb-1"><strong>Hs:</strong> @loadResult.FittedHs.ToString("F1") m</p>
                        <p class="mb-0"><strong>Tz:</strong> @loadResult.FittedTz.ToString("F1") s</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // Control file data
    private VesselInfo? vesselInfo = null;
    private RepresentativeDraft? representativeDrafts = null;
    private ParameterBound parameterBounds = new();
    private string? controlFileError = null;

    // Chart reference
    private SfChart? chartRef;

    // Application state
    private PolarLoadParameters parameters = new()
        {
            Draft = "scantling",
            GM = 1.5,
            Hs = 5.5,
            Tz = 7.5,
            DraftAftPeak = 0.5,
            DraftForePeak = 0.5
        };

    private double vesselHeading = 5;
    private double vesselSpeed = 10;
    private double waveDirection = 0;
    private double maxRollAngle = 15;
    private string displayMode = "trafficlight";
    private string directionMode = "northup";

    private bool isLoading = false;
    private bool hasData = false;
    private string? errorMessage = null;
    private PolarLoadResult? loadResult = null;

    // Chart data
    private List<PolarChartData> chartDataPoints = new();
    private List<PolarChartData> vesselMarker = new();
    private List<PolarChartData> waveMarker = new();
    private double maxSpeed = 20;
    private double startAngle = 90;
    private double coefficient = 100;

    // Case management
    private List<SavedCase> savedCases = new();
    private int currentCaseIndex = 0;

    // Dropdown options
    private List<string> draftOptions = new() { "scantling", "design", "intermediate" };

    // Color palettes
    private string[] continuousColors = new[]
    {
        "#0d47a1", "#1565c0", "#1976d2", "#1e88e5", "#2196f3",
        "#42a5f5", "#64b5f6", "#90caf9", "#bbdefb", "#e3f2fd",
        "#ffffbf", "#fff59d", "#fff176", "#ffee58", "#ffeb3b",
        "#fdd835", "#fbc02d", "#f9a825", "#f57f17", "#ff6f00",
        "#ff8f00", "#ffa726", "#ffb74d", "#ffcc80", "#ffe0b2",
        "#ffab91", "#ff8a65", "#ff7043", "#ff5722", "#f4511e",
        "#e64a19", "#d84315", "#bf360c", "#a50026", "#8b0000"
    };

    public class SavedCase
    {
        public string Id { get; set; } = "";
        public PolarLoadParameters Parameters { get; set; } = new();
        public bool IsInDangerZone { get; set; }
    }

    public class PolarChartData
    {
        public double Angle { get; set; }
        public double Speed { get; set; }
        public double Roll { get; set; }
        public string Color { get; set; } = "#ffffff";
        public string Tooltip { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        LoadControlFileFromDataFolder();
        await base.OnInitializedAsync();
    }

    private void LoadControlFileFromDataFolder()
    {
        try
        {
            string dataPath = PolarService.GetDataRootPath();
            string[] possibleNames = { "proll.ctl", "control.txt", "vessel.ctl" };
            string? controlFilePath = null;

            foreach (var name in possibleNames)
            {
                string testPath = System.IO.Path.Combine(dataPath, name);
                if (System.IO.File.Exists(testPath))
                {
                    controlFilePath = testPath;
                    break;
                }
            }

            if (controlFilePath != null)
            {
                if (PolarService.LoadControlFile(controlFilePath))
                {
                    vesselInfo = PolarService.GetVesselInfo();
                    representativeDrafts = PolarService.GetRepresentativeDrafts();
                    parameterBounds = PolarService.GetParameterBounds();
                    controlFileError = null;
                }
                else
                {
                    controlFileError = $"Found control file but failed to parse: {System.IO.Path.GetFileName(controlFilePath)}";
                }
            }
            else
            {
                controlFileError = "Control file not found in data folder. Using default parameters.";
                parameterBounds = new ParameterBound
                    {
                        GM_lower = 0.5,
                        GM_upper = 5.0,
                        Hs_lower = 3.0,
                        Hs_upper = 12.0,
                        Tz_lower = 5.0,
                        Tz_upper = 18.0
                    };
            }
        }
        catch (Exception ex)
        {
            controlFileError = $"Error loading control file: {ex.Message}";
        }
    }

    private void OnDisplayModeChanged(ChangeArgs<string> args)
    {
        if (hasData)
        {
            PrepareChartData();
            StateHasChanged();
        }
    }

    private async Task LoadAndRenderData()
    {
        isLoading = true;
        errorMessage = null;
        hasData = false;
        StateHasChanged();

        await Task.Delay(100);

        try
        {
            loadResult = PolarService.LoadPolarData(parameters);

            if (!loadResult.Success)
            {
                errorMessage = loadResult.ErrorMessage;
                return;
            }

            hasData = true;
            PrepareChartData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
            hasData = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void PrepareChartData()
    {
        if (loadResult?.Data == null)
            return;

        var data = loadResult.Data;
        chartDataPoints.Clear();
        vesselMarker.Clear();
        waveMarker.Clear();

        // Set chart ranges
        maxSpeed = Math.Ceiling(data.Speeds.Max() * 1.1);
        startAngle = directionMode == "northup" ? 90 : 90; // Always 90 for polar
        coefficient = 100;

        // Prepare main data points
        for (int i = 0; i < data.SpeedCount; i++)
        {
            for (int j = 0; j < data.HeadingCount; j++)
            {
                double displayAngle = CalculateDisplayAngle(data.Headings[j]);
                double rollValue = data.MaxRoll[i, j];
                string color = GetColorForRoll(rollValue);

                chartDataPoints.Add(new PolarChartData
                    {
                        Angle = displayAngle,
                        Speed = data.Speeds[i],
                        Roll = rollValue,
                        Color = color,
                        Tooltip = rollValue.ToString("F2")
                    });
            }
        }

        // Add vessel marker
        if (vesselSpeed > 0)
        {
            double vesselAngle = directionMode == "northup" ? vesselHeading : 0;
            vesselMarker.Add(new PolarChartData
                {
                    Angle = vesselAngle,
                    Speed = vesselSpeed,
                    Roll = 0,
                    Color = "#FFFFFF",
                    Tooltip = "Vessel Position"
                });
        }

        // Add wave direction marker
        double waveDisplayAngle = directionMode == "northup" ? waveDirection : (waveDirection - vesselHeading);
        while (waveDisplayAngle < 0) waveDisplayAngle += 360;
        while (waveDisplayAngle >= 360) waveDisplayAngle -= 360;

        waveMarker.Add(new PolarChartData
            {
                Angle = waveDisplayAngle,
                Speed = maxSpeed * 0.95,
                Roll = 0,
                Color = "#FF1493",
                Tooltip = "Wave Direction"
            });
    }

    private double CalculateDisplayAngle(double headingFromData)
    {
        double angle;

        if (directionMode == "northup")
        {
            angle = 180 + (vesselHeading - headingFromData);
        }
        else
        {
            angle = 180 - headingFromData;
        }

        while (angle < 0) angle += 360;
        while (angle >= 360) angle -= 360;

        return angle;
    }

    private string GetColorForRoll(double rollValue)
    {
        if (displayMode == "trafficlight")
        {
            if (rollValue < maxRollAngle - 5)
                return "#2ecc71"; // Green
            else if (rollValue < maxRollAngle)
                return "#f39c12"; // Orange
            else
                return "#e74c3c"; // Red
        }
        else // continuous
        {
            double ratio = Math.Min(rollValue / maxRollAngle, 1.0);
            int colorIndex = (int)(ratio * (continuousColors.Length - 1));
            colorIndex = Math.Max(0, Math.Min(colorIndex, continuousColors.Length - 1));
            return continuousColors[colorIndex];
        }
    }

    private async Task SaveCase()
    {
        var newCase = new SavedCase
            {
                Id = $"Case {savedCases.Count + 1}",
                Parameters = new PolarLoadParameters
                {
                    Draft = parameters.Draft,
                    GM = parameters.GM,
                    Hs = parameters.Hs,
                    Tz = parameters.Tz,
                    DraftAftPeak = parameters.DraftAftPeak,
                    DraftForePeak = parameters.DraftForePeak
                },
                IsInDangerZone = CheckIfInDangerZone()
            };

        savedCases.Add(newCase);
        currentCaseIndex = savedCases.Count - 1;
        StateHasChanged();
    }

    private bool CheckIfInDangerZone()
    {
        if (chartDataPoints == null || !chartDataPoints.Any())
            return false;

        return chartDataPoints.Any(p => p.Roll > maxRollAngle);
    }

    private void LoadCase(int index)
    {
        if (index >= 0 && index < savedCases.Count)
        {
            currentCaseIndex = index;
            parameters = savedCases[index].Parameters;
            _ = LoadAndRenderData();
        }
    }

    private void PreviousCase()
    {
        if (currentCaseIndex > 0)
        {
            LoadCase(currentCaseIndex - 1);
        }
    }

    private void NextCase()
    {
        if (currentCaseIndex < savedCases.Count - 1)
        {
            LoadCase(currentCaseIndex + 1);
        }
    }

    private async Task ExportChart()
    {
        try
        {
            if (chartRef != null)
            {
                await chartRef.ExportAsync(Syncfusion.Blazor.Charts.ExportType.PNG, "PolarChart");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
            await Task.Delay(2000);
            errorMessage = null;
        }
    }
}
